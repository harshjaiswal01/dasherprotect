openapi: 3.0.3
info:
  title: Dasher Protect API
  version: "0.1.0"
  description: |
    MVP surface for Dasher Protect.
    - **M0**: health, readiness, hello.
    - **M1**: persons, face enrollment, identify, gallery feed.

servers:
  - url: http://localhost:5001
    description: Local (docker-compose)

paths:
  /healthz:
    get:
      summary: Liveness probe
      tags: [system]
      responses:
        "200":
          description: OK

  /readyz:
    get:
      summary: Readiness probe (DB/Redis ping)
      tags: [system]
      responses:
        "200":
          description: Ready

  /v1/hello:
    get:
      summary: API prefix check
      tags: [system]
      responses:
        "200":
          description: OK

  /v1/persons:
    post:
      summary: Create a person
      tags: [enrollment]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PersonCreate"
            example:
              display_name: "Ada Lovelace"
              is_flagged: true
              metadata:
                notes: "VIP"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Person"
        "400":
          description: Invalid input

  /v1/persons/{person_id}/faces:
    post:
      summary: Enroll face embeddings for a person
      tags: [enrollment]
      parameters:
        - in: path
          name: person_id
          required: true
          schema:
            type: string
          description: Person identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FaceEnroll"
            example:
              embedding: [0.01, -0.02, 0.003, 0.12]   # (truncated; 512 dims)
              thumbnail_b64: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQ..."
      responses:
        "201":
          description: Enrolled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FaceEnrollResult"
        "400":
          description: Invalid input
        "404":
          description: Person not found

  /v1/identify:
    post:
      summary: Identify an embedding against enrolled faces
      description: |
        Returns the best match and whether it passes the configured threshold.
      tags: [identify]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IdentifyRequest"
            example:
              embedding: [0.01, -0.03, 0.004, 0.22]   # (truncated; 512 dims)
              thumbnail_b64: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQ..."
              device_id: "tablet-123"
              location_id: "loc-001"
              captured_at: "2025-08-13T18:02:31Z"
      responses:
        "200":
          description: Identification result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IdentifyResponse"

  /v1/sightings:
    get:
      summary: Rolling gallery (last 3 hours)
      tags: [gallery]
      parameters:
        - in: query
          name: since
          schema:
            type: string
            format: date-time
          description: ISO timestamp; defaults to now-3h
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        "200":
          description: Page of recent sightings
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/Sighting"
                  next_since:
                    type: string
                    format: date-time
                    nullable: true

components:
  schemas:
    PersonCreate:
      type: object
      required: [display_name]
      properties:
        display_name:
            type: string
        is_flagged:
            type: boolean
            default: false
        metadata:
            type: object
            additionalProperties: true

    Person:
      type: object
      properties:
        id:
          type: string
          example: "p_abc123"
        display_name:
          type: string
        is_flagged:
          type: boolean
        metadata:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    FaceEnroll:
      type: object
      required: [embedding]
      properties:
        embedding:
          description: 512-dim L2-normalized face embedding
          type: array
          minItems: 512
          maxItems: 512
          items:
            type: number
            format: float
        thumbnail_b64:
          type: string
          description: Data URL (e.g., data:image/jpeg;base64,....)
          nullable: true

    FaceEnrollResult:
      type: object
      properties:
        face_id:
          type: string
        person_id:
          type: string
        created_at:
          type: string
          format: date-time

    IdentifyRequest:
      type: object
      required: [embedding, device_id, location_id, captured_at]
      properties:
        embedding:
          type: array
          minItems: 512
          maxItems: 512
          items:
            type: number
            format: float
        thumbnail_b64:
          type: string
          description: Data URL (e.g., data:image/jpeg;base64,....)
          nullable: true
        device_id:
          type: string
        location_id:
          type: string
        captured_at:
          type: string
          format: date-time

    IdentifyResponse:
      type: object
      properties:
        person_id:
          type: string
          nullable: true
        is_match:
          type: boolean
        distance:
          type: number
          format: float
        threshold:
          type: number
          format: float
        is_flagged:
          type: boolean

    Sighting:
      type: object
      properties:
        id:
          type: string
        person_id:
          type: string
          nullable: true
        is_match:
          type: boolean
        is_flagged:
          type: boolean
        distance:
          type: number
          format: float
        threshold:
          type: number
          format: float
        device_id:
          type: string
        location_id:
          type: string
        captured_at:
          type: string
          format: date-time
        thumbnail_b64:
          type: string
          description: Data URL (thumbnail)
          nullable: true
        created_at:
          type: string
          format: date-time

tags:
  - name: system
    description: Health/ready and sanity endpoints
  - name: enrollment
    description: Person and face enrollment
  - name: identify
    description: Identify embeddings against enrolled faces
  - name: gallery
    description: Rolling gallery feed
